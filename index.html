<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KarmaKit - Help Builders Get Users & Feedback</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="enhanced-header">
    <div class="header-content">
      <div class="logo-section">
        <img src="karmakit-logo.png" class="logo" alt="KarmaKit">
        <div class="brand-text">
          <h1>KarmaKit</h1>
          <p class="tagline">Help builders get users and validate ideas</p>
        </div>
      </div>
      <nav class="main-nav">
        <button class="nav-btn active" onclick="navigate('index.html')">
          <span class="nav-icon">üè†</span>
          Home
        </button>
        <button class="nav-btn" onclick="navigate('submit.html')">
          <span class="nav-icon">üöÄ</span>
          Submit Idea
        </button>
        <button class="nav-btn" onclick="navigate('profile.html')">
          <span class="nav-icon">üë§</span>
          Profile
        </button>
      </nav>
    </div>
    <div class="user-status">
      <div class="karma-display">
        <span class="karma-icon">‚≠ê</span>
        <span id="karma-count">0</span>
        <span class="karma-label">Karma</span>
      </div>
      <p id="greeting" class="user-greeting"></p>
    </div>
  </header>

  <main class="main-content">
    <div class="hero-section">
      <h2 class="hero-title">Discover Amazing Projects</h2>
      <p class="hero-subtitle">Swipe through innovative ideas, give feedback, and earn karma points!</p>
    </div>

    <div class="card-container" id="card-container">
      <div class="loading-spinner" id="loading-spinner">
        <div class="spinner"></div>
        <p>Loading projects...</p>
      </div>
    </div>

    <div class="controls">
      <button id="pass-btn" class="control-btn pass-btn" disabled>
        <span class="btn-icon">‚è≠Ô∏è</span>
        Maybe Later
        <span class="karma-reward">+2</span>
      </button>
      <button id="like-btn" class="control-btn like-btn" disabled>
        <span class="btn-icon">‚ù§Ô∏è</span>
        Love This!
        <span class="karma-reward">+2</span>
      </button>
    </div>

    <div class="action-section">
      <button class="submit-cta" onclick="navigate('submit.html')">
        <span class="cta-icon">‚ú®</span>
        Submit Your Idea
        <span class="cta-subtitle">Share your project and get feedback</span>
      </button>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-number" id="total-projects">0</span>
        <span class="stat-label">Projects</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="total-feedback">0</span>
        <span class="stat-label">Feedback Given</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="active-builders">0</span>
        <span class="stat-label">Active Builders</span>
      </div>
    </div>
  </main>

  <!-- Enhanced Comment Modal -->
  <div class="modal" id="comment-modal">
    <div class="modal-overlay" onclick="closeModal()"></div>
    <div class="modal-content enhanced-modal">
      <div class="modal-header">
        <h2>üí¨ Leave Feedback</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <textarea 
          id="comment-text" 
          placeholder="Share your thoughts, suggestions, or questions about this project..."
          maxlength="500"
        ></textarea>
        <div class="char-counter">
          <span id="char-count">0</span>/500
        </div>
        <div class="feedback-options">
          <label class="checkbox-label">
            <input type="checkbox" id="connect-checkbox">
            <span class="checkmark"></span>
            I'd like to connect with this builder
          </label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" id="comment-submit" disabled>
          Submit Feedback
          <span class="karma-bonus">+3 karma</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Connection Modal -->
  <div class="modal" id="connection-modal">
    <div class="modal-overlay" onclick="closeConnectionModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>ü§ù Connect with Builder</h2>
        <button class="close-btn" onclick="closeConnectionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Share your contact info to connect with this builder:</p>
        <input type="email" id="connect-email" placeholder="your.email@example.com">
        <textarea id="connect-message" placeholder="Optional: Add a personal message..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeConnectionModal()">Cancel</button>
        <button class="btn-primary" id="connect-submit">Send Connection Request</button>
      </div>
    </div>
  </div>

  <!-- Welcome/Signup Modal -->
  <div class="modal" id="welcome-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>üöÄ Welcome to KarmaKit!</h2>
      </div>
      <div class="modal-body">
        <div class="welcome-content">
          <div class="welcome-icon">‚ú®</div>
          <h3>Help builders get users and validate ideas</h3>
          <p>Join our community of builders! Give feedback, earn karma points, and connect with other innovators.</p>
          
          <form id="welcome-form">
            <label>
              Your Name *
              <input type="text" id="welcome-name" required maxlength="50" placeholder="Enter your name">
            </label>
            
            <label>
              Email (optional)
              <input type="email" id="welcome-email" placeholder="your.email@example.com">
            </label>
            
            <label>
              Company/Organization (optional)
              <input type="text" id="welcome-company" maxlength="100" placeholder="Your startup, company, or school">
            </label>
            
            <div class="welcome-benefits">
              <h4>üéÅ What you'll get:</h4>
              <ul>
                <li>‚≠ê Earn karma points for every interaction</li>
                <li>üí¨ Give and receive valuable feedback</li>
                <li>ü§ù Connect with other builders</li>
                <li>üìä Track your impact and achievements</li>
              </ul>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="skipWelcome()">Skip for now</button>
        <button class="btn-primary" onclick="completeWelcome()">
          <span class="btn-icon">üöÄ</span>
          Start Building!
        </button>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  <div class="toast" id="success-toast">
    <div class="toast-content">
      <span class="toast-icon">üéâ</span>
      <span class="toast-message"></span>
    </div>
  </div>

<script>
// Enhanced navigation with active states
function navigate(page) { 
  document.body.classList.add('page-loading');
  setTimeout(() => {
    window.location = page;
  }, 300);
}

// Enhanced error handling and utilities
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function safeSetItem(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (e) {
    console.error('Storage error:', e);
    showToast('Unable to save data. Storage might be full.', 'error');
    return false;
  }
}

function safeGetItem(key, fallback = null) {
  try {
    return localStorage.getItem(key) || fallback;
  } catch (e) {
    console.error('Storage read error:', e);
    return fallback;
  }
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('success-toast');
  const messageEl = toast.querySelector('.toast-message');
  const iconEl = toast.querySelector('.toast-icon');
  
  messageEl.textContent = message;
  iconEl.textContent = type === 'success' ? 'üéâ' : '‚ö†Ô∏è';
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// FIXED: Enhanced karma tracking functions
function initializeKarmaTracking() {
  if (!safeGetItem('karmaBreakdown')) {
    const breakdown = {
      projectsSubmitted: 0,
      projectsLiked: 0, 
      feedbackGiven: 0,
      projectsReviewed: 0
    };
    safeSetItem('karmaBreakdown', JSON.stringify(breakdown));
  }
}

function updateKarmaBreakdown(action, points) {
  const breakdown = JSON.parse(safeGetItem('karmaBreakdown', '{"projectsSubmitted":0,"projectsLiked":0,"feedbackGiven":0,"projectsReviewed":0}'));
  
  switch(action) {
    case 'submit':
      breakdown.projectsSubmitted += points;
      break;
    case 'like':
      breakdown.projectsLiked += points;
      break;
    case 'feedback':
      breakdown.feedbackGiven += points;
      break;
    case 'review':
      breakdown.projectsReviewed += points;
      break;
  }
  
  safeSetItem('karmaBreakdown', JSON.stringify(breakdown));
}

// Enhanced data initialization
function init() {
  initializeKarmaTracking();
  
  if (!safeGetItem('companies')) {
    const defaultCompanies = [
      {
        id: 1,
        name: "EcoTrack",
        logo: "https://via.placeholder.com/100/4CAF50/FFFFFF?text=ET",
        idea: "AI-powered carbon footprint tracker for personal sustainability goals",
        link: "#",
        likes: 12,
        comments: [
          {text: "Love the eco-focus!", author: "Builder_123", timestamp: new Date().toISOString()},
          {text: "Great UI design", author: "Builder_456", timestamp: new Date().toISOString()},
          {text: "Could use more features", author: "Builder_789", timestamp: new Date().toISOString()}
        ],
        connections: [],
        submittedBy: "Demo_User",
        timestamp: new Date().toISOString()
      },
      {
        id: 2,
        name: "StudyBuddy",
        logo: "https://via.placeholder.com/100/2196F3/FFFFFF?text=SB",
        idea: "Collaborative study platform with AI-generated quiz questions",
        link: "#",
        likes: 8,
        comments: [
          {text: "Perfect for students!", author: "Builder_321", timestamp: new Date().toISOString()},
          {text: "Amazing concept", author: "Builder_654", timestamp: new Date().toISOString()}
        ],
        connections: [],
        submittedBy: "Demo_User_2",
        timestamp: new Date().toISOString()
      },
      {
        id: 3,
        name: "FoodieMatch",
        logo: "https://via.placeholder.com/100/FF9800/FFFFFF?text=FM",
        idea: "Tinder for restaurants - swipe to discover new dining experiences",
        link: "#",
        likes: 15,
        comments: [
          {text: "Brilliant idea!", author: "Builder_111", timestamp: new Date().toISOString()},
          {text: "I would use this daily", author: "Builder_222", timestamp: new Date().toISOString()}
        ],
        connections: [],
        submittedBy: "Demo_User_3",
        timestamp: new Date().toISOString()
      }
    ];
    safeSetItem('companies', JSON.stringify(defaultCompanies));
  }
  
  if (!safeGetItem('karma')) safeSetItem('karma', '0');
  if (!safeGetItem('profile')) {
    safeSetItem('profile', JSON.stringify({
      user: 'Builder_' + Math.floor(Math.random() * 1000),
      company: '',
      email: '',
      bio: '',
      allowConnections: true,
      showEmail: false
    }));
  }
  if (!safeGetItem('totalFeedbackGiven')) safeSetItem('totalFeedbackGiven', '0');
}

let companies, currentIndex = 0;

function load() { 
  companies = JSON.parse(safeGetItem('companies', '[]'));
  updateStats();
}

function saveCompanies() { 
  safeSetItem('companies', JSON.stringify(companies)); 
  updateStats();
}

function addKarma(points) {
  let k = parseInt(safeGetItem('karma', '0'), 10); 
  k += points;
  safeSetItem('karma', k.toString());
  updateKarmaDisplay();
  animateKarmaGain(points);
}

function updateKarmaDisplay() {
  document.getElementById('karma-count').textContent = safeGetItem('karma', '0');
}

function animateKarmaGain(points) {
  const karmaDisplay = document.querySelector('.karma-display');
  karmaDisplay.classList.add('karma-gained');
  setTimeout(() => {
    karmaDisplay.classList.remove('karma-gained');
  }, 600);
}

function updateStats() {
  document.getElementById('total-projects').textContent = companies.length;
  document.getElementById('total-feedback').textContent = safeGetItem('totalFeedbackGiven', '0');
  document.getElementById('active-builders').textContent = Math.min(companies.length * 2, 50);
}

function renderGreeting() {
  const profile = JSON.parse(safeGetItem('profile', '{"user":"Guest","company":""}'));
  document.getElementById('greeting').textContent = `Welcome back, ${profile.user}!`;
}

function renderCard() {
  if (companies.length === 0) {
    showEmptyState();
    return;
  }

  const c = companies[currentIndex];
  const container = document.getElementById('card-container');
  
  const spinner = document.getElementById('loading-spinner');
  if (spinner) spinner.style.display = 'none';
  
  container.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div class="card-header">
      <img src="${c.logo}" alt="${escapeHtml(c.name)}" onerror="this.src='https://via.placeholder.com/100'">
      <div class="card-title-section">
        <h2>${escapeHtml(c.name)}</h2>
        <div class="project-badge">Project #${c.id}</div>
      </div>
    </div>
    <div class="card-body">
      <p class="project-idea">${escapeHtml(c.idea)}</p>
    </div>
    <div class="card-stats">
      <div class="stat">
        <span class="stat-icon">‚ù§Ô∏è</span>
        <span class="stat-number">${c.likes}</span>
        <span class="stat-text">likes</span>
      </div>
      <div class="stat">
        <span class="stat-icon">üí¨</span>
        <span class="stat-number">${c.comments ? c.comments.length : 0}</span>
        <span class="stat-text">feedback</span>
      </div>
      <div class="stat">
        <span class="stat-icon">ü§ù</span>
        <span class="stat-number">${c.connections ? c.connections.length : 0}</span>
        <span class="stat-text">connections</span>
      </div>
    </div>
    <div class="card-actions">
      <button class="card-btn visit-btn" onclick="window.open('${c.link}', '_blank')">
        <span class="btn-icon">üîó</span>
        Visit Project
      </button>
      <button class="card-btn comment-btn" onclick="openModal()">
        <span class="btn-icon">üí¨</span>
        Give Feedback
      </button>
    </div>
  `;
  
  container.appendChild(card);
  document.getElementById('pass-btn').disabled = false;
  document.getElementById('like-btn').disabled = false;
  setTimeout(() => card.classList.add('show'), 50);
}

function showEmptyState() {
  const container = document.getElementById('card-container');
  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">üì±</div>
      <h3>No projects yet!</h3>
      <p>Be the first to submit your idea and start the feedback loop.</p>
      <button class="btn-primary" onclick="navigate('submit.html')">Submit First Project</button>
    </div>
  `;
}

function nextCard() {
  const card = document.querySelector('.card');
  if (card) {
    card.classList.add('card-exit');
    setTimeout(() => {
      currentIndex = (currentIndex + 1) % companies.length;
      renderCard();
    }, 300);
  }
}

// FIXED: Both actions now give +2 karma for honest feedback
function handlePass() { 
  updateKarmaBreakdown('review', 2); // Changed from 1 to 2
  addKarma(2); // Changed from 1 to 2
  showToast('+2 karma for reviewing!'); // Updated message
  nextCard(); 
}

function handleLike() { 
  companies[currentIndex].likes++; 
  saveCompanies(); 
  updateKarmaBreakdown('like', 2); // Stays 2
  addKarma(2); // Stays 2
  showToast('+2 karma for loving this project!'); // Updated message
  nextCard(); 
}

// Enhanced modal functions
function openModal() {
  document.getElementById('comment-modal').classList.add('active');
  document.body.classList.add('modal-open');
  document.getElementById('comment-text').focus();
}

function closeModal() {
  document.getElementById('comment-modal').classList.remove('active');
  document.body.classList.remove('modal-open');
  document.getElementById('comment-text').value = '';
  document.getElementById('connect-checkbox').checked = false;
  updateCommentButton();
}

function openConnectionModal() {
  document.getElementById('connection-modal').classList.add('active');
}

function closeConnectionModal() {
  document.getElementById('connection-modal').classList.remove('active');
  document.getElementById('connect-email').value = '';
  document.getElementById('connect-message').value = '';
}

function updateCommentButton() {
  const text = document.getElementById('comment-text').value.trim();
  const submitBtn = document.getElementById('comment-submit');
  submitBtn.disabled = text.length === 0;
}

function updateCharCount() {
  const text = document.getElementById('comment-text').value;
  document.getElementById('char-count').textContent = text.length;
  updateCommentButton();
}

// FIXED: Enhanced comment submission with proper tracking
function submitComment() {
  const txt = document.getElementById('comment-text').value.trim();
  const wantsConnection = document.getElementById('connect-checkbox').checked;
  
  if (txt) {
    const profile = JSON.parse(safeGetItem('profile', '{"user":"Guest"}'));
    
    companies[currentIndex].comments.push({
      text: txt,
      author: profile.user,
      timestamp: new Date().toISOString()
    });
    
    if (wantsConnection) {
      if (!companies[currentIndex].connections) {
        companies[currentIndex].connections = [];
      }
      companies[currentIndex].connections.push({
        message: txt,
        author: profile.user,
        timestamp: new Date().toISOString()
      });
    }
    
    saveCompanies();
    updateKarmaBreakdown('feedback', 3);
    addKarma(3);
    
    let totalFeedback = parseInt(safeGetItem('totalFeedbackGiven', '0'), 10);
    totalFeedback++;
    safeSetItem('totalFeedbackGiven', totalFeedback.toString());
    
    closeModal();
    
    if (wantsConnection) {
      showToast('Feedback sent & connection request made! +3 karma');
      setTimeout(() => openConnectionModal(), 1000);
    } else {
      showToast('Feedback submitted! +3 karma');
    }
    
    renderCard();
  }
}

function submitConnection() {
  const email = document.getElementById('connect-email').value.trim();
  if (email) {
    showToast('Connection request sent!');
    closeConnectionModal();
  } else {
    alert('Please enter your email address');
  }
}

// Welcome modal functions
function showWelcomeModal() {
  document.getElementById('welcome-modal').classList.add('active');
  document.body.classList.add('modal-open');
  document.getElementById('welcome-name').focus();
}

function hideWelcomeModal() {
  document.getElementById('welcome-modal').classList.remove('active');
  document.body.classList.remove('modal-open');
}

function completeWelcome() {
  const name = document.getElementById('welcome-name').value.trim();
  const email = document.getElementById('welcome-email').value.trim();
  const company = document.getElementById('welcome-company').value.trim();
  
  if (!name) {
    showToast('Please enter your name', 'error');
    return;
  }
  
  const profile = {
    user: escapeHtml(name),
    email: escapeHtml(email),
    company: escapeHtml(company),
    bio: '',
    allowConnections: true,
    showEmail: false,
    welcomeCompleted: true,
    joinDate: new Date().toISOString()
  };
  
  safeSetItem('profile', JSON.stringify(profile));
  hideWelcomeModal();
  renderGreeting();
  showToast(`Welcome to KarmaKit, ${name}! üéâ`);
}

function skipWelcome() {
  const profile = JSON.parse(safeGetItem('profile', '{}'));
  profile.welcomeCompleted = true;
  safeSetItem('profile', JSON.stringify(profile));
  hideWelcomeModal();
  showToast('Welcome to KarmaKit! You can update your profile anytime.');
}

function checkFirstVisit() {
  const profile = JSON.parse(safeGetItem('profile', '{}'));
  if (!profile.welcomeCompleted) {
    setTimeout(() => {
      showWelcomeModal();
    }, 1000);
  }
}

// Event listeners
window.onload = () => {
  init(); 
  load(); 
  renderGreeting(); 
  updateKarmaDisplay();
  checkFirstVisit();
  
  setTimeout(() => {
    renderCard();
  }, 800);
  
  document.getElementById('pass-btn').onclick = handlePass;
  document.getElementById('like-btn').onclick = handleLike;
  document.getElementById('comment-submit').onclick = submitComment;
  document.getElementById('connect-submit').onclick = submitConnection;
  
  const commentText = document.getElementById('comment-text');
  commentText.addEventListener('input', updateCharCount);
  commentText.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
      submitComment();
    }
  });
  
  document.addEventListener('keydown', (e) => {
    if (!document.querySelector('.modal.active')) {
      if (e.key === 'ArrowLeft' || e.key === 'a') handlePass();
      if (e.key === 'ArrowRight' || e.key === 'd') handleLike();
      if (e.key === ' ') {
        e.preventDefault();
        openModal();
      }
    }
    if (e.key === 'Escape') {
      closeModal();
      closeConnectionModal();
      hideWelcomeModal();
    }
  });
};
</script>

<style>
.welcome-content {
  text-align: center;
  padding: 1rem 0;
}

.welcome-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.welcome-content h3 {
  color: var(--primary);
  margin-bottom: 1rem;
  font-size: 1.3rem;
}

.welcome-content p {
  color: var(--text-gray);
  margin-bottom: 2rem;
  line-height: 1.6;
}

#welcome-form {
  text-align: left;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

#welcome-form label {
  display: flex;
  flex-direction: column;
  font-weight: 600;
  color: var(--primary);
  gap: 0.5rem;
}

#welcome-form input {
  padding: 0.75rem;
  border-radius: 8px;
  border: 2px solid rgba(48, 31, 79, 0.1);
  font-family: inherit;
  transition: var(--transition);
}

#welcome-form input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(48, 31, 79, 0.1);
}

.welcome-benefits {
  background: linear-gradient(135deg, rgba(247, 201, 75, 0.1), rgba(247, 201, 75, 0.05));
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid rgba(247, 201, 75, 0.3);
  margin-top: 1rem;
}

.welcome-benefits h4 {
  color: var(--primary);
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.welcome-benefits ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.welcome-benefits li {
  font-size: 0.8rem;
  padding: 0.25rem 0;
  color: var(--text-dark);
}
</style>
</body>
</html>